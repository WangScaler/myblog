{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{633:function(s,a,e){\"use strict\";e.r(a);var t=e(1),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":s.$parent.slotKey}},[e(\"h2\",{attrs:{id:\"linux-操作系统参数\"}},[e(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#linux-操作系统参数\"}},[s._v(\"#\")]),s._v(\" Linux 操作系统参数\")]),s._v(\" \"),e(\"p\",[s._v(\"系统全局允许分配的最大文件句柄数:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"# 2 millions system-wide\\n#默认值1048576\\nsysctl -w fs.file-max=2097152\\n#默认值1048576\\nsysctl -w fs.nr_open=2097152\\necho 2097152 > /proc/sys/fs/nr_open\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),e(\"br\")])]),e(\"p\",[s._v(\"允许当前会话 / 进程打开文件句柄数:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"ulimit -n 1048576\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\")])]),e(\"h3\",{attrs:{id:\"etc-sysctl-conf\"}},[e(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#etc-sysctl-conf\"}},[s._v(\"#\")]),s._v(\" /etc/sysctl.conf\")]),s._v(\" \"),e(\"p\",[s._v(\"持久化 'fs.file-max' 设置到 /etc/sysctl.conf 文件:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"fs.file-max = 1048576\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\")])]),e(\"p\",[s._v(\"/etc/systemd/system.conf 设置服务最大文件句柄数:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"DefaultLimitNOFILE=1048576\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\")])]),e(\"h3\",{attrs:{id:\"etc-security-limits-conf\"}},[e(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#etc-security-limits-conf\"}},[s._v(\"#\")]),s._v(\" /etc/security/limits.conf\")]),s._v(\" \"),e(\"p\",[s._v(\"/etc/security/limits.conf 持久化设置允许用户 / 进程打开文件句柄数:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"*      soft   nofile      1048576\\n*      hard   nofile      1048576\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\")])]),e(\"h2\",{attrs:{id:\"tcp-协议栈网络参数\"}},[e(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#tcp-协议栈网络参数\"}},[s._v(\"#\")]),s._v(\" TCP 协议栈网络参数\")]),s._v(\" \"),e(\"p\",[s._v(\"并发连接 backlog 设置:\")]),s._v(\" \"),e(\"p\",[s._v(\"对于一个TCP连接，Server与Client需要通过三次握手来建立网络连接.当三次握手成功后,我们可以看到端口的状态由LISTEN转变为ESTABLISHED,接着这条链路上就可以开始传送数据了。\")]),s._v(\" \"),e(\"p\",[s._v(\"对于服务器而言，一个完整的连接建立过程，服务器会经历 2 种 TCP 状态：SYN_REVD, ESTABELLISHED。对应也会维护两个队列：\\n\\\\1. 一个存放 SYN 的队列（半连接队列）\\n\\\\2. 一个存放已经完成连接的队列（全连接队列）\\n当一个连接的状态是 SYN RECEIVED 时，它会被放在 SYN 队列中。当它的状态变为 ESTABLISHED 时，它会被转移到另一个队列。所以后端的应用程序只从已完成的连接的队列中获取请求。\\n如果一个服务器要处理大量网络连接，且并发性比较高，那么这两个队列长度就非常重要了。因为，即使服务器的硬件配置非常高，服务器端程序性能很好，但是这两个队列非常小，那么经常会出现客户端连接不上的现象，因为这两个队列一旦满了后，很容易丢包，或者连接被复位。所以，如果服务器并发访问量非常高，那么这两个队列的设置就非常重要了。\")]),s._v(\" \"),e(\"div\",{staticClass:\"language-bash line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[e(\"code\",[e(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#backlog是socket的监听队列，当一个请求（request）尚未被处理或建立时，他会进入backlog。而socket server可以一次性处理backlog中的所有请求，处理后的请求不再位于监听队列中。当server处理请求较慢，以至于监听队列被填满后，新来的请求会被拒绝128\")]),s._v(\"\\nsysctl -w net.core.somaxconn\"),e(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),e(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"32768\")]),s._v(\"\\n\"),e(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#是指定所能接受SYN同步包的最大客户端数量，即半连接上限，默认值是128,即SYN_REVD状态的连接数。4096\")]),s._v(\"\\nsysctl -w net.ipv4.tcp_max_syn_backlog\"),e(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),e(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"16384\")]),s._v(\"\\n\"),e(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#在每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目1000\")]),s._v(\"\\nsysctl -w net.core.netdev_max_backlog\"),e(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),e(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"16384\")]),s._v(\"\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),e(\"br\")])]),e(\"p\",[s._v(\"可用知名端口范围:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"#默认值32768    60999\\nsysctl -w net.ipv4.ip_local_port_range='1000 65535'\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\")])]),e(\"p\",[s._v(\"TCP Socket 读写 Buffer 设置:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"#默认值\\nsysctl -w net.core.rmem_default=262144\\n#默认值\\nsysctl -w net.core.wmem_default=262144\\n#默认值\\nsysctl -w net.core.rmem_max=16777216\\n#默认值\\nsysctl -w net.core.wmem_max=16777216\\n#默认值\\nsysctl -w net.core.optmem_max=16777216\\n\\n#sysctl -w net.ipv4.tcp_mem='16777216 16777216 16777216'\\n#默认值\\nsysctl -w net.ipv4.tcp_rmem='1024 4096 16777216'\\n#默认值\\nsysctl -w net.ipv4.tcp_wmem='1024 4096 16777216'\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),e(\"br\")])]),e(\"p\",[s._v(\"TCP 连接追踪设置:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"#默认值\\nsysctl -w net.nf_conntrack_max=1000000\\n#默认值\\nsysctl -w net.netfilter.nf_conntrack_max=1000000\\n#默认值\\nsysctl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=30\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),e(\"br\")])]),e(\"p\",[s._v(\"TIME-WAIT Socket 最大数量、回收与重用设置:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"#默认值\\nsysctl -w net.ipv4.tcp_max_tw_buckets=1048576\\n\\n# 注意：不建议开启該设置，NAT 模式下可能引起连接 RST\\n# sysctl -w net.ipv4.tcp_tw_recycle=1\\n# sysctl -w net.ipv4.tcp_tw_reuse=1\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),e(\"br\")])]),e(\"p\",[s._v(\"FIN-WAIT-2 Socket 超时设置:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v(\"#默认值\\nsysctl -w net.ipv4.tcp_fin_timeout=15\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\")])]),e(\"h2\",{attrs:{id:\"erlang-虚拟机参数\"}},[e(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#erlang-虚拟机参数\"}},[s._v(\"#\")]),s._v(\" Erlang 虚拟机参数\")]),s._v(\" \"),e(\"p\",[s._v(\"优化设置 Erlang 虚拟机启动参数，配置文件 emqx/etc/emqx.conf:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language-bash line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[e(\"code\",[e(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"## Erlang Process Limit\")]),s._v(\"\\n\"),e(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#默认值\")]),s._v(\"\\nnode.process_limit \"),e(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),e(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2097152\")]),s._v(\"\\n\\n\"),e(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"## Sets the maximum number of simultaneously existing ports for this system\")]),s._v(\"\\n\"),e(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#默认值\")]),s._v(\"\\nnode.max_ports \"),e(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),e(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1048576\")]),s._v(\"\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),e(\"br\")])]),e(\"h2\",{attrs:{id:\"emq-x-消息服务器参数\"}},[e(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#emq-x-消息服务器参数\"}},[s._v(\"#\")]),s._v(\" EMQ X 消息服务器参数\")]),s._v(\" \"),e(\"p\",[s._v(\"设置 TCP 监听器的 Acceptor 池大小，最大允许连接数。配置文件 emqx/etc/emqx.conf:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language-bash line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[e(\"code\",[e(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"## TCP Listener\")]),s._v(\"\\nlistener.tcp.external \"),e(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),e(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0.0\")]),s._v(\".0.0:1883\\nlistener.tcp.external.acceptors \"),e(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),e(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"64\")]),s._v(\"\\nlistener.tcp.external.max_connections \"),e(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),e(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1024000\")]),s._v(\"\\n\")])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),e(\"br\")])]),e(\"h2\",{attrs:{id:\"测试客户端设置\"}},[e(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#测试客户端设置\"}},[s._v(\"#\")]),s._v(\" 测试客户端设置\")]),s._v(\" \"),e(\"p\",[s._v(\"测试客户端服务器在一个接口上，最多只能创建 65000 连接:\")]),s._v(\" \"),e(\"div\",{staticClass:\"language- line-numbers-mode\"},[e(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[e(\"code\",[s._v('sysctl -w net.ipv4.ip_local_port_range=\"500 65535\"\\necho 1000000 > /proc/sys/fs/nr_open\\nulimit -n 100000\\n')])]),s._v(\" \"),e(\"div\",{staticClass:\"line-numbers-wrapper\"},[e(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),e(\"br\"),e(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),e(\"br\")])]),e(\"h3\",{attrs:{id:\"\"}},[e(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#\"}},[s._v(\"#\")])])])}),[],!1,null,null,null);a.default=n.exports}}]);","extractedComments":[]}